name: ImmortalWrt Build (Rockchip ARMv8 Fuse Packages)

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        persist-credentials: true
        submodules: recursive

    - name: Install build dependencies
      run: |
        sudo apt-get update -y
        sudo apt-get install -y \
          build-essential clang llvm gawk flex bison gettext \
          libncurses-dev libssl-dev libelf-dev zlib1g-dev \
          rsync unzip file wget curl \
          python3 python3-dev python3-setuptools python3-pyelftools \
          perl ccache upx swig

    - name: Debug repo state
      run: |
        echo "WORKDIR: $(pwd)"
        ls -la
        git status --porcelain || true
        git rev-parse --is-inside-work-tree || true

    - name: Clone ImmortalWrt source
      run: |
        set -eux
        # clone official ImmortalWrt into subfolder 'immortalwrt'
        git clone https://github.com/immortalwrt/immortalwrt.git immortalwrt
        cd immortalwrt
        git rev-parse --is-inside-work-tree
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Prepare .config and defconfig
      run: |
        set -eux
        # ensure your repository root contains a .config file
        if [ ! -f .config ]; then
          echo ".config not found in repo root" >&2
          exit 1
        fi
        cp .config immortalwrt/.config
        cd immortalwrt
        # verify .config present and run defconfig
        ls -la .config
        make defconfig

    - name: Build selected packages
      run: |
        set -eux
        cd immortalwrt
        # compile only packages enabled in .config
        make package/compile V=s

    - name: Collect package artifacts (diagnose paths)
      run: |
        set -eux
        echo "Listing possible package output directories"
        ls -la immortalwrt/bin/packages || true
        ls -la immortalwrt/bin/packages/armv8 || true
        ls -la immortalwrt/bin/packages/aarch64_generic || true
        ls -la immortalwrt/bin/targets || true
        # create a small manifest for debugging
        find immortalwrt/bin -type f -name "*.ipk" -print > ipk-list.txt || true
        echo "IPK list:"
        cat ipk-list.txt || true

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: fuse-packages-armv8
        path: |
          immortalwrt/bin/packages/armv8/base/*.ipk
          immortalwrt/bin/packages/aarch64_generic/base/*.ipk
          immortalwrt/bin/packages/*/base/*.ipk
          immortalwrt/bin/targets/rockchip/armv8/*.ipk
          ipk-list.txt



