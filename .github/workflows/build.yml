name: ImmortalWrt Build (Rockchip ARMv8 Fuse Packages)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      MAKEFLAGS: "-j1"
    timeout-minutes: 720

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        persist-credentials: true
        submodules: false

    - name: Setup cache for dl and sstate and ccache
      uses: actions/cache@v4
      with:
        path: |
          immortalwrt/dl
          immortalwrt/staging_dir
          immortalwrt/build_dir
          ~/.ccache
        key: ${{ runner.os }}-immortalwrt-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-immortalwrt-

    - name: Install system dependencies
      run: |
        sudo apt-get update -y
        sudo apt-get install -y \
          build-essential clang llvm gawk flex bison gettext \
          libncurses-dev libssl-dev libelf-dev zlib1g-dev \
          rsync unzip file wget curl ca-certificates \
          python3 python3-dev python3-setuptools python3-pyelftools \
          python3-distutils python3-distutils-extra \
          liblzma-dev libbz2-dev libzstd-dev libz-dev \
          perl ccache upx swig pkg-config

    - name: Checkout ImmortalWrt source (clone into subfolder)
      run: |
        git clone --depth 1 https://github.com/immortalwrt/immortalwrt.git immortalwrt
        cd immortalwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Prepare .config and defconfig
      run: |
        cp .config immortalwrt/.config
        cd immortalwrt
        make defconfig

    - name: Build host tools (ensure libdeflate-gzip etc exist)
      run: |
        cd immortalwrt
        MAKEFLAGS="$MAKEFLAGS" make tools/compile V=s

    - name: Build selected packages
      run: |
        cd immortalwrt
        MAKEFLAGS="$MAKEFLAGS" make package/compile V=s

    - name: Collect package artifacts
      run: |
        cd immortalwrt
        find bin -type f -name "*.ipk" -print > ../ipk-list.txt || true
        ls -la bin || true
        cat ../ipk-list.txt || true

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: fuse-packages-armv8
        path: |
          immortalwrt/bin/packages/*/base/*.ipk
          immortalwrt/bin/targets/**/**/*.ipk
